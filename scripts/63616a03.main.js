function hideMarkers(a,b,c){"undefined"==typeof a&&(a=500),"undefined"==typeof b&&(b=3),"undefined"==typeof c&&(c=10);var d=d3.selectAll("circle.marker");d.transition().duration(a).delay(function(a,c){return b*c}).style("fill-opacity",0).transition().delay(function(a,b){return c*b}).attr("r",0).remove()}function hideLinks(a,b,c){"undefined"==typeof a&&(a=500),"undefined"==typeof b&&(b=3),"undefined"==typeof c&&(c=10);var d=d3.select("#map svg").selectAll("circle.destination");d.transition().duration(a).delay(function(a,c){return b*c}).style("fill-opacity",0).transition().delay(function(a,b){return c*b}).attr("r",0).remove();var e=d3.select("#map svg").selectAll("circle.source");e.transition().duration(a).delay(function(a,c){return b*c}).style("fill-opacity",0).transition().delay(function(a,b){return c*b}).attr("r",0).remove();var f=d3.select("#map svg").selectAll("path.shippingPath");f.transition().duration(a).delay(function(a,c){return b*c}).style("stroke-opacity",0).remove();var g=d3.select("#map svg").selectAll("path.button");g.transition().duration(a).delay(function(a,b){return 100*b}).style("stroke-opacity",0).attr("r",0).remove(),d3.selectAll("circle.marker").transition().duration(a).attr("r",function(a){return rScale.func(a)}),d3.selectAll("circle.buttons").remove(),tableData={headers:["Source","Destination","$ (million)"],rows:[["-","-","-"]]},d3.select("div#table").datum(tableData).call(tableFunc)}function growDS(a,b,c,d){d3.select(b).attr("r");d3.select(b).transition().duration(d/2).delay(0).attr("r",function(a){return rScale.func(a)+1}),d3.select(b).transition().duration(d/2).delay(500).attr("r",rScale.func(a))}function pathGrow(a,b,c,d){linksLayer.select(c+":nth-child("+(b+1)+")").transition().duration(d/2).style("stroke-width",function(a){return rScale.func(a)+4}).style("stroke","#FFCA1B")}function pathShrink(a,b,c,d){linksLayer.select(c+":nth-child("+(b+1)+")").transition().duration(d/2).style("stroke-width",function(a){return rScale.func(a)}).style("stroke",function(){return"#EA3556"})}function update(){+new Date,+new Date;updateProjection(),d3.selectAll("image").on("mousedown",function(){update.downtime=+new Date}).on("mouseup",function(){update.uptime=+new Date}).on("click",function(){var a=update.uptime-update.downtime;150>=a&&hideLinks(500)}),locsLayer.selectAll("circle.marker").attr("transform",transform),linksLayer.selectAll("path.shippingPath").attr("d",function(a){return a?path(arc({from:a.from,to:[a.lon,a.lat]})):void 0}),destinationsLayer.selectAll("circle.destination").attr("transform",function(a){return a?transform(a):void 0}),sourcesLayer.selectAll("circle.source").attr("transform",function(a){return a?transform(a):void 0}),buttonsLayer.selectAll("path.button.Inbound").attr("transform",function(a){return a?transformSourceButton(a):void 0}),buttonsLayer.selectAll("path.button.Outbound").attr("transform",function(a){return a?transformDestButton(a):void 0}),buttonsLayer.selectAll("circle.buttons").attr("transform",function(a){return a?transform(a):void 0})}function updateProjection(){var a=map.locationPoint({lat:0,lon:0});a=[a.x,a.y];var b=map.zoom();projection.translate(a).scale(256*Math.pow(2,b))}function transform(a){return a=map.locationPoint({lon:a.lon,lat:a.lat}),"translate("+a.x+","+a.y+")"}function transformSourceButton(a){return a=map.locationPoint({lon:a.lon,lat:a.lat}),"translate("+a.x+","+a.y+")"}function transformDestButton(a){return a=map.locationPoint({lon:a.lon,lat:a.lat}),"translate("+a.x+","+a.y+")"}function drawSliderBar(){var a=d3.time.format("%Y"),b=d3.time.format("%Y"),c=700,d=70,e=d3.time.scale().domain([b.parse("2000"),b.parse("2014")]).range([0,14]),f=d3.time.scale().domain(e.domain()).range([50,c-10]),g=d3.select("#axis").append("svg:svg").attr("width",c).attr("height",d).append("svg:g"),h=d3.svg.axis().scale(f).ticks(d3.time.years,1).tickSize(10).tickFormat(a);g.append("svg:g").attr("class","x axis").attr("width",c).attr("height",d).call(h)}function showAllTransfers(a,b){function c(a){tableData={headers:["Source","Destination","$ (million)"],rows:[]},a.destinations.sort(function(a,b){return b.units-a.units});var c=linksLayer.selectAll("path.shippingPath").data(a.destinations);c.enter().append("svg:path").attr("class","shippingPath"),c.exit().remove(),linksLayer.selectAll("path.shippingPath").transition().duration(b).delay(function(a,b){return 10*b}).attr("d",function(a){return path(arc({from:a.from,to:[a.lon,a.lat]}))}).style("stroke-opacity",.5).style("stroke-width",function(a){return rScale.func(a)}).style("stroke",function(){return"#EA3556"}).style("fill","none")}rScale.data=a,tableData={headers:["Source","Destination","$ (million)"],rows:[]},a.forEach(function(a){if(a.destinations){a.destinations.sort(function(a,b){return b.units-a.units});for(var b=0;b<a.destinations.length;b++)tableData.rows.push([a.name,a.destinations[b].name,d3NumberFormat(a.destinations[b].units).replace(/\B(?=(\d{3})+(?!\d))/g,",")])}}),d3.select("div#table").datum(tableData).call(tableFunc);var d=d3.select("div#table");d.selectAll("tbody tr").on("mouseover",function(a,c){pathGrow(a,c,"path.shippingPath",b)}).on("mouseout",function(a,c){pathShrink(a,c,"path.shippingPath",b)});var e=locsLayer.selectAll("circle").data(a);e.enter().append("svg:circle").attr("class","marker").data(a).attr("r",0).attr("transform",transform).on("mouseover",function(a){grow(a,this,b);var c=d3.mouse(this.parentNode),d=d3.select("#map").property("offsetTop"),e=d3.select("#map").property("offsetLeft"),f=d3.select("#tooltip").style("left",e+c[0]+"px").style("top",d+c[1]+20+"px");f.select("#value").text(numberWithCommas.func(a)),f.select("#title").text(a.name),d3.select("#tooltip").classed("hidden",!1)}).on("mouseout",function(){d3.select("#tooltip").classed("hidden",!0)}).on("click",function(a,b){hideLinks(),makeFilterButtons(this,a,b)}),e.append("svg:circle").attr("class","marker").data(a).attr("r",0),d3.selectAll("circle.marker").transition().duration(b).delay(function(a,b){return 10*b}).attr("r",function(a){return rScale.func(a)+1}),map.on("move",update),map.on("resize",update),newData=[],newData.destinations=[];for(var f=0;f<a.length;f++)a[f].destinations&&a[f].destinations.forEach(function(b){newDatum=b,newDatum.from=[a[f].lon,a[f].lat],newData.destinations.push(newDatum)});c(newData),setTimeout(function(){update()},1e3)}function grow(a,b,c){if(d3.selectAll("path.button")[0].length<2){{d3.select(b).attr("r")}d3.select(b).transition().duration(c/2).delay(0).attr("r",function(a){return rScale.func(a)+1}).attr("fill","#FFCA1B"),d3.select(b).transition().duration(c/2).delay(500).attr("r",rScale.func(a))}}function showTransfers(a,b){function c(a,c,f){hideLinks(),d3.selectAll("circle.marker").transition().duration(b/1.5).attr("r",2),d3.select(a).transition().duration(b/1.5).attr("r",10);var h=this;c.buttons=[{type:function(){return"Inbound"},lat:c.lat,lon:c.lon,source:!0,name:c.name,units:function(){return{units:c.units}},colour:"#0000FF",stroke:"black",clickfunct:function(){e.call(h,c,f)},transformFunct:transformSourceButton,destinations:c.destinations,sources:c.sources,rFunct:function(){return sum=d3.sum(c.sources,function(a){return parseFloat(a.units)}),sum},startAngle:Math.PI,endAngle:2*Math.PI,sumSources:function(){if(!c.sources||c.sources.length<1)return 0;var a=d3.sum(c.sources,function(a){return parseFloat(a.units)});return{units:a}}},{type:function(){return"Outbound"},lat:c.lat,lon:c.lon,source:!0,name:c.name,units:function(){return{units:c.units}},colour:"#F3F315",stroke:"black",clickfunct:function(){d.call(h,c,f)},transformFunct:transformDestButton,destinations:c.destinations,sources:c.sources,rFunct:function(){return sum=d3.sum(c.destinations,function(a){return parseFloat(a.units)}),sum},startAngle:0,endAngle:Math.PI,sumDests:function(){var a=d3.sum(c.destinations,function(a){return parseFloat(a.units)});return{units:a}}}];var i=d3.select("#map svg").selectAll("g.buttons"),j=d3.svg.arc().innerRadius(10).outerRadius(function(a){return 10+g.func(a)}).startAngle(function(a){return a.startAngle}).endAngle(function(a){return a.endAngle}),k=i.selectAll("path.button").data(c.buttons);k.enter().append("svg:path").attr("class",function(a){return"button "+a.type()}).attr("d",j.outerRadius(10)).style("fill",function(a){return a.colour}).style("opacity",.5).style("stroke","black").style("stroke-opacity",1).style("stroke-width",1).attr("startAngle",function(a){return"Inbound"==a.type()?Math.PI:2*Math.PI}).attr("endAngle",function(a){return"Outbound"==a.type()?180*(Math.PI/180):0}).attr("transform",function(a){return a.transformFunct(a)}).on("click",function(a){a.clickfunct()}).on("mouseover",function(a){var b=d3.mouse(this.parentNode),c=d3.select("#map").property("offsetTop"),d=d3.select("#map").property("offsetLeft"),e=d3.select("#tooltip").style("left",d+b[0]+"px").style("top",c+b[1]+20+"px");e.select("#value").text(function(){return"Outbound"==a.type()?numberWithCommas.func(a.sumDests()):"Inbound"==a.type()?numberWithCommas.func(a.sumSources()):0}),e.select("#title").text(function(){return a.type()}),d3.select("#tooltip").classed("hidden",!1).classed("dest",!0)}).on("mouseout",function(){d3.select("#tooltip").classed("hidden",!0).classed("dest",!1)}).transition().duration(b).attr("d",j.outerRadius(function(a){return 10+g.func(a)})),k.exit().remove();var l=[];l.push({lat:c.lat,lon:c.lon,source:!0,name:c.name,units:c.units}),i.selectAll("circle").data(l).enter().append("circle").attr("class","buttons").attr("transform",function(a){return a?transform(a):void 0}).attr("opacity",0).attr("r",10).on("mouseover",function(a){var b=d3.mouse(this.parentNode),c=d3.select("#map").property("offsetTop"),d=d3.select("#map").property("offsetLeft"),e=d3.select("#tooltip").style("left",d+b[0]+"px").style("top",c+b[1]+20+"px");e.select("#value").text(numberWithCommas.func(a)),e.select("#title").text(a.name),d3.select("#tooltip").classed("hidden",!1)}).on("mouseout",function(){d3.select("#tooltip").classed("hidden",!0)}).on("click",function(){hideLinks()})}function d(c){tableData={headers:["Source","Destination","$ (million)"],rows:[]},console.log(c),c.destinations.sort(function(a,b){return b.units-a.units});for(var d=0;d<c.destinations.length;d++)tableData.rows.push([c.name,c.destinations[d].name,d3NumberFormat(c.destinations[d].units).replace(/\B(?=(\d{3})+(?!\d))/g,",")]);d3.select("div#table").datum(tableData).call(tableFunc);var e=d3.select("div#table");e.selectAll("tbody tr").on("mouseover",function(a,c){pathGrow(a,c,"path.shippingPath",b)}).on("mouseout",function(a,c){pathShrink(a,c,"path.shippingPath",b)}),d3.selectAll("circle.marker").transition().duration(b/1.5).attr("r",1);var f=[c.lon,c.lat],g=linksLayer.selectAll("path.shippingPath").data(c.destinations);g.enter().append("svg:path").attr("class","shippingPath"),g.exit().remove(),linksLayer.selectAll("path.shippingPath").transition().duration(b).delay(function(a,b){return 10*b}).attr("d",function(a){return a.from=f,path(arc({from:f,to:[a.lon,a.lat]}))}).style("stroke-opacity",.5).style("stroke-width",function(a){return rScale.func(a)}).style("stroke",function(){return"#EA3556"}).style("fill","none");var h=d3.select("#map svg").selectAll("g.destinations"),i=h.selectAll("circle.destination").data(c.destinations);i.enter().append("svg:circle").attr("class","destination"),i.exit().remove(),h.selectAll("circle.destination").attr("transform",function(a){return a?transform(a):void 0}).style("fill","none").style("stroke-opacity",.5).transition().duration(b/1.5).attr("r",function(a){return null===a?3:rScale.func(a)}).style("stroke",function(){return"#F00"}).style("fill",function(a){return null===a?"yellow":a.source?"#081D41":"yellow"}),h.selectAll("circle.destination").on("mouseover",function(c){growDS(c,this,a,b);var d=d3.mouse(this.parentNode),e=d3.select("#map").property("offsetTop"),f=d3.select("#map").property("offsetLeft"),g=d3.select("#tooltip").style("left",f+d[0]+"px").style("top",e+d[1]+20+"px");g.select("#value").text(numberWithCommas.func(c)),g.select("#title").text(c.name),d3.select("#tooltip").classed("hidden",!1).classed("dest",!0)}).on("mouseout",function(){d3.select("#tooltip").classed("hidden",!0).classed("dest",!1)}).on("click",hideLinks);var j=[];j.push({lat:c.lat,lon:c.lon,source:!0,name:c.name,units:c.units}),buttonsLayer.selectAll("circle").data(j).enter().append("circle").attr("class","buttons marker").attr("transform",function(a){return a?transform(a):void 0}).attr("opacity",0).attr("r",10).on("mouseover",function(a){var b=d3.mouse(this.parentNode),c=d3.select("#map").property("offsetTop"),d=d3.select("#map").property("offsetLeft"),e=d3.select("#tooltip").style("left",d+b[0]+"px").style("top",c+b[1]+20+"px");e.select("#value").text(numberWithCommas.func(a)),e.select("#title").text(a.name),d3.select("#tooltip").classed("hidden",!1)}).on("mouseout",function(){d3.select("#tooltip").classed("hidden",!0)}).on("click",function(){hideLinks()})}function e(c,d){if(c.sources){tableData={headers:["Source","Destination","$ (million)"],rows:[]},c.sources.sort(function(a,b){return b.units-a.units});for(var d=0;d<c.sources.length;d++)tableData.rows.push([c.sources[d].name,c.name,d3NumberFormat(c.sources[d].units).replace(/\B(?=(\d{3})+(?!\d))/g,",")]);d3.select("div#table").datum(tableData).call(tableFunc);var e=d3.select("div#table");e.selectAll("tbody tr").on("mouseover",function(a,b){pathGrow(a,b,"path.shippingPath")}).on("mouseout",function(a,b){pathShrink(a,b,"path.shippingPath","#207836")}),d3.selectAll("circle.marker").transition().duration(b/1.5).attr("r",1);var f=[c.lon,c.lat],g=linksLayer.selectAll("path.shippingPath").data(c.sources);g.enter().append("svg:path").attr("class","shippingPath"),g.exit().remove(),linksLayer.selectAll("path.shippingPath").transition().duration(b).delay(function(a,b){return 10*b}).attr("d",function(a){return a.from=f,path(arc({from:f,to:[a.lon,a.lat]}))}).style("stroke-opacity",.5).style("stroke-width",function(a){return rScale.func(a)}).style("stroke",function(){return"#5EFFA9"}).style("fill","none");var h=d3.select("#map svg").selectAll("g.sources"),i=h.selectAll("circle.source").data(c.sources);i.enter().append("svg:circle").attr("class","source"),i.exit().remove(),h.selectAll("circle.source").attr("transform",function(a){return a?transform(a):void 0}).style("fill","none").style("stroke-opacity",.5).transition().duration(b/1.5).attr("r",function(a){return rScale.func(a)}).style("stroke",function(){return"#D80DFC"}).style("fill",function(a){return null===a?"0D75FC":a.source?"#0D75FC":"0D75FC"}),h.selectAll("circle.source").on("mouseover",function(c){growDS(c,this,a,b);var d=d3.mouse(this.parentNode),e=d3.select("#map").property("offsetTop"),f=d3.select("#map").property("offsetLeft"),g=d3.select("#tooltip").style("left",f+d[0]+"px").style("top",e+d[1]+20+"px");g.select("#value").text(numberWithCommas.func(c)),g.select("#title").text(c.name),d3.select("#tooltip").classed("hidden",!1).classed("dest",!0)}).on("mouseout",function(){d3.select("#tooltip").classed("hidden",!0).classed("dest",!1)}).on("click",hideLinks);var j=[];j.push({lat:c.lat,lon:c.lon,source:!0,name:c.name,units:c.units}),buttonsLayer.selectAll("circle").data(j).enter().append("circle").attr("class","buttons marker").attr("transform",function(a){return a?transform(a):void 0}).attr("opacity",0).attr("r",10).on("mouseover",function(a){var b=d3.mouse(this.parentNode),c=d3.select("#map").property("offsetTop"),d=d3.select("#map").property("offsetLeft"),e=d3.select("#tooltip").style("left",d+b[0]+"px").style("top",c+b[1]+20+"px");e.select("#value").text(numberWithCommas.func(a)),e.select("#title").text(a.name),d3.select("#tooltip").classed("hidden",!1)}).on("mouseout",function(){d3.select("#tooltip").classed("hidden",!0)}).on("click",function(){hideLinks()})}}rScale.data=a,tableData={headers:["Source","Destination","$ (million)"],rows:[["-","-","-"]]},d3.select("div#table").datum(tableData).call(tableFunc);var f=locsLayer.selectAll("circle").data(a);f.enter().append("svg:circle").attr("class","marker").data(a).attr("r",0).attr("transform",transform).on("mouseover",function(a){grow(a,this,b);var c=d3.mouse(this.parentNode),d=d3.select("#map").property("offsetTop"),e=d3.select("#map").property("offsetLeft");console.log("offsets: "+d+"	"+e);var f=d3.select("#tooltip").style("left",+c[0]+5+"px").style("top",d+c[1]+20+"px");f.select("#value").text(numberWithCommas.func(a)),f.select("#title").text(a.name),d3.select("#tooltip").classed("hidden",!1)}).on("mouseout",function(){d3.select("#tooltip").classed("hidden",!0)}).on("click",function(a,b){hideLinks(),c(this,a,b)}),f.append("svg:circle").attr("class","marker").data(a).attr("r",0),d3.selectAll("circle.marker").transition().duration(b).delay(function(a,b){return 5*b}).attr("r",function(a){return rScale.func(a)+1}),map.on("move",update),map.on("resize",update);var g={func:function(a){if(r=0,sumDests=0,a.destinations&&(sumDests=d3.sum(a.destinations,function(a){return parseFloat(a.units)})),sumSources=0,maxNum=0,"Inbound"==a.type()&&!a.sources)return 1;a.sources&&(sumSources=d3.sum(a.sources,function(a){return parseFloat(a.units)}),maxNum=Math.max(sumDests,sumSources)),maxNum=Math.max(sumDests,sumSources),markerR=rScale.func(a.units());var b=d3.scale.linear().range([1,markerR]).domain([1,maxNum]).clamp("true");return r=b("Inbound"==a.type()?sumSources:sumDests),r}}}$(window).resize(function(){$("#map").height($(window).height()-100),$("#sidebar").height($(window).height()-100),$("#table").height($(window).height()-100)}),$(window).trigger("resize");var po=org.polymaps,map=po.map().container(d3.select("#map").append("svg").node()).zoom(2).center({lat:20,lon:0}).add(po.interact());map.add(po.image().url(po.url("http://api.tiles.mapbox.com/v4/hubertrogers.j0idljd8/{Z}/{X}/{Y}.png?access_token=sk.eyJ1IjoiaHViZXJ0cm9nZXJzIiwiYSI6ImRwYjV0MTQifQ.0AgjbqhTKyiHMjOWEXUJOA").hosts(["a.","b.","c.",""])));var compass=po.compass().position("bottom-left").pan("small");map.add(compass);var pt=map.locationPoint({lat:0,lon:0}),projection=d3.geo.mercator().translate([pt.x,pt.y]).scale(256*Math.pow(2,map.zoom())),path=d3.geo.path().projection(projection),arc=d3.geo.greatArc().source(function(a){return a.from}).target(function(a){return a.to}),rScale={data:[],func:function(a){return scaleUnits=d3.scale.linear().domain([0,d3.max(rScale.data,function(a){return parseFloat(a.units)})]).range([4,20]),scaleUnits(a.units)}},rdBuScale=d3.scale.quantile().domain([0,1]).range(colorbrewer.RdBu[5]),locsLayer=d3.select("#map svg").insert("svg:g",".compass").attr("class","locs"),linksLayer=d3.select("#map svg").insert("svg:g",".compass").attr("class","links"),buttonsLayer=d3.select("#map svg").selectAll("g.buttons").data([[]]);buttonsLayer.enter().insert("svg:g",".compass").attr("class","buttons");var destinationsLayer=d3.select("#map svg").selectAll("g.destinations").data([[]]);destinationsLayer.enter().insert("svg:g",".compass").attr("class","destinations");var sourcesLayer=d3.select("#map svg").selectAll("g.sources").data([[]]);sourcesLayer.enter().insert("svg:g",".compass").attr("class","sources");var tableFunc=table();update(),d3.json("data/migrations.json",function(a){showTransfers(a,1e3),drawSliderBar(a)});var d3NumberFormat=d3.format(".3r"),numberWithCommas={shipmentsFlag:!1,func:function(a){return 1==numberWithCommas.shipmentsFlag?parseFloat(a.shipments).toPrecision(3).toString().replace(/\B(?=(\d{3})+(?!\d))/g,","):d3NumberFormat(parseFloat(a.units)).replace(/\B(?=(\d{3})+(?!\d))/g,",")},miles:function(a){return parseFloat(a).toFixed(0).toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}};